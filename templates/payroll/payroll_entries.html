{% extends "base.html" %}

{% block title %}จัดการรายการเงินเดือน{% endblock %}

{% block head_extra %}
<style>
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be responsive */
        max-width: 800px; /* Max width */
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .detail-card {
        background-color: #f0fdf4; /* Tailwind green-50 */
        border: 1px solid #dcfce7; /* Tailwind green-200 */
        padding: 1rem;
        border-radius: 0.375rem; /* rounded-md */
        margin-bottom: 1rem;
    }
    .detail-card h4 {
        font-weight: 600; /* font-semibold */
        color: #16a34a; /* Tailwind green-600 */
        margin-bottom: 0.5rem;
    }
    .detail-card p {
        font-size: 0.875rem; /* text-sm */
        color: #1f2937; /* text-gray-800 */
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">จัดการรายการเงินเดือน</h2>

    <!-- ส่วนสำหรับคำนวณ/สร้างรายการเงินเดือน -->
    <div class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">คำนวณและเพิ่มรายการเงินเดือน</h3>
        <form id="calculatePayrollEntryForm" class="space-y-4">
            <div>
                <label for="calcEmployeeId" class="block text-sm font-medium text-gray-700 mb-1">พนักงาน <span class="text-red-500">*</span></label>
                <select id="calcEmployeeId" name="employee_id" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <!-- Options will be loaded by JS -->
                </select>
            </div>
            <div>
                <label for="calcPayrollRunId" class="block text-sm font-medium text-gray-700 mb-1">รอบการจ่ายเงินเดือน <span class="text-red-500">*</span></label>
                <select id="calcPayrollRunId" name="payroll_run_id" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <!-- Options will be loaded by JS -->
                </select>
            </div>
            <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                คำนวณและบันทึก
            </button>
        </form>
        <div id="calculatePayrollEntryMessage" class="mt-4 text-sm font-medium"></div>
    </div>

    <div class="flex items-end gap-3 mb-4">
    <div>
        <label class="block text-sm text-gray-600 mb-1">เดือน</label>
        <input type="month" id="reportMonth" class="border rounded px-2 py-1">
    </div>
    <div>
        <label class="block text-sm text-gray-600 mb-1">&nbsp;</label>
        <button id="btnViewReport" class="bg-sky-600 hover:bg-sky-700 text-white px-3 py-2 rounded">ดูรายงาน</button>
        <button id="btnCsvReport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">ดาวน์โหลด CSV</button>
    </div>
    </div>

    <!-- พื้นที่แสดง JSON สรุป (ตัวเลือก) -->
    <div id="reportBox" class="hidden rounded border p-3 bg-gray-50 text-sm"></div>

    <!-- ฟิลเตอร์ค้นหา / ช่วงวันที่ / สถานะ -->
    <!-- Toolbar: ค้นหา + กรอง + เรียง -->
    <form id="payrollSearchForm" class="pe-toolbar">
    <div class="pe-row">
    <div class="pe-field">
      <label>ค้นหา</label>
      <input id="searchEmployeeKeyword" name="q" type="text" placeholder="ชื่อ/รหัสพนักงาน" />
    </div>
    <div class="pe-field">
      <label>ช่วงวันที่</label>
      <input id="searchStartDate" name="start" type="date" />
      <input id="searchEndDate" name="end" type="date" />
    </div>
    <div class="pe-actions">
      <button type="submit" class="btn primary">ค้นหา</button>
      <button type="button" id="clearPayrollSearch" class="btn ghost">ล้างค่า</button>
    </div>
    </div>
    </form>

    <!-- ส่วนสำหรับแสดงรายการเงินเดือน -->
    <div>
        <h3 class="text-xl font-semibold text-gray-700 mb-4">รายการเงินเดือน</h3>
        <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ID
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            รอบ Payroll
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            พนักงาน
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            เงินเดือนรวม
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            เงินเดือนสุทธิ
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            สถานะการจ่าย
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            การดำเนินการ
                        </th>
                    </tr>
                </thead>
                <tbody id="payrollEntriesTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- ข้อมูลรายการเงินเดือนจะถูกโหลดด้วย JavaScript ที่นี่ -->
                    <tr>
                        <td colspan="7" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            กำลังโหลดข้อมูล...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="payrollEntriesMessage" class="mt-4 text-sm font-medium text-gray-700"></div>
    </div>

    <!-- Modal สำหรับแสดงรายละเอียด/แก้ไขรายการเงินเดือน -->
    <div id="editPayrollEntryModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">รายละเอียด/แก้ไขรายการเงินเดือน</h3>
            <form id="editPayrollEntryForm" class="space-y-4">
                <input type="hidden" id="editPayrollEntryId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">รอบ Payroll:</label>
                    <input type="text" id="editPayrollRunName" disabled
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100 cursor-not-allowed sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">พนักงาน:</label>
                    <input type="text" id="editEmployeeName" disabled
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100 cursor-not-allowed sm:text-sm">
                </div>
                <div>
                    <label for="editGrossSalary" class="block text-sm font-medium text-gray-700 mb-1">เงินเดือนรวม (ก่อนหัก) <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="editGrossSalary" name="gross_salary" required min="0"
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="editNetSalary" class="block text-sm font-medium text-gray-700 mb-1">เงินเดือนสุทธิ (หลังหัก) <span class="text-red-500">*</span></label>
                    <input type="number" step="0.01" id="editNetSalary" name="net_salary" required min="0"
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                
                <!-- Dynamic Allowances Details -->
                <div id="editCalculatedAllowances" class="detail-card">
                    <h4>รายละเอียดเบี้ยเลี้ยงที่คำนวณ</h4>
                    <!-- Allowances will be dynamically loaded here -->
                </div>

                <!-- Dynamic Deductions Details -->
                <div id="editCalculatedDeductions" class="detail-card">
                    <h4>รายละเอียดรายการหักที่คำนวณ</h4>
                    <!-- Deductions will be dynamically loaded here -->
                </div>

                <div>
                    <label for="editPaymentDate" class="block text-sm font-medium text-gray-700 mb-1">วันที่จ่ายจริง</label>
                    <input type="date" id="editPaymentDate" name="payment_date"
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="editPaymentStatus" class="block text-sm font-medium text-gray-700 mb-1">สถานะการจ่าย <span class="text-red-500">*</span></label>
                    <select id="editPaymentStatus" name="payment_status" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="Pending">Pending</option>
                        <option value="Paid">Paid</option>
                        <option value="Failed">Failed</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="closeEditModalButton"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        ยกเลิก
                    </button>
                    <button type="submit"
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        บันทึก
                    </button>
                </div>
            </form>
            <div id="editPayrollEntryMessage" class="mt-4 text-sm font-medium"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/payroll/payroll_entries.js?v=20250906"></script>
{% endblock %}
