{% extends "base.html" %}
{% block title %}จัดการสิทธิ์{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-6">
  <h1 class="text-2xl font-bold mb-4">จัดการสิทธิ์ (Roles & Permissions)</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <!-- ซ้าย: Roles -->
  <div class="md:col-span-1">
    <h2 class="font-semibold mb-2">Roles</h2>
    <select id="roleSelect" class="w-full border rounded px-3 py-2"></select>
    <p class="text-sm text-gray-500 mt-2">เลือก Role เพื่อกำหนด Permission</p>
  </div>

  <!-- ขวา: Permissions + เลือกพนักงาน -->
  <div class="md:col-span-2 space-y-6">
    <!-- Permissions -->
    <div>
      <h2 class="font-semibold mb-2">Permissions</h2>
      <div id="permList" class="space-y-2"></div>
    </div>

    <!-- ย้ายมาที่นี่: กำหนด Role ให้พนักงาน -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">กำหนด Role ให้พนักงาน</h2>

      <label class="block text-sm mb-1">พนักงาน</label>
      <select id="empSelect" class="w-full border rounded p-2 mb-4">
        <option value="">— เลือกพนักงาน —</option>
      </select>

      <div id="empRoleList" class="space-y-2">
        <!-- จะถูกเติมเช็คบ็อกซ์ role จาก JS -->
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function api(url, opts = {}) {
  const res = await fetch(url, opts);
  if (!res.ok) {
    const t = await res.text();
    throw new Error(t || res.statusText);
  }
  return res.json();
}

let roles = [];
let perms = [];
let currentRoleId = null;
let currentRolePermIds = [];
let currentUserId = null;

// ---------- helpers ----------
function asArray(x) {
  if (Array.isArray(x)) return x;
  if (x && Array.isArray(x.items)) return x.items;
  if (x && Array.isArray(x.data)) return x.data;
  return []; // กันพลาด
}

// ---------- load roles/permissions ----------
async function loadRoles() {
  const resp = await api('/api/v1/security/roles');
  // เดิม: roles = asArray(resp)
  roles = Array.isArray(resp) ? resp : (resp.roles || []);
  const sel = document.getElementById('roleSelect');
  sel.innerHTML = '';
  roles.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = r.name;
    sel.appendChild(opt);
  });
  if (roles.length) {
    currentRoleId = roles[0].id;
    sel.value = currentRoleId;
  }
}

async function loadPerms() {
  const resp = await api('/api/v1/security/perms');
  // เดิม: perms = asArray(resp)
  perms = Array.isArray(resp) ? resp : (resp.permissions || []);
}

async function loadRolePerms(roleId) {
  const resp = await api(`/api/v1/security/role-perms/${roleId}`);
  // เดิม: currentRolePermIds = asArray(resp.permission_ids ?? resp)
  currentRolePermIds = Array.isArray(resp) ? resp : (resp.permission_ids || []);
}

function renderPerms() {
  const box = document.getElementById('permList');
  box.innerHTML = '';
  perms.forEach(p => {
    const wrap = document.createElement('label');
    wrap.className = "flex items-center gap-3 border rounded px-3 py-2";

    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = currentRolePermIds.includes(p.id);
    chk.addEventListener('change', () => toggleRolePerm(currentRoleId, p.id, chk.checked));

    const txt = document.createElement('div');
    txt.innerHTML = `<div class="font-medium">${p.code}</div><div class="text-xs text-gray-500">${p.description || ''}</div>`;

    wrap.appendChild(chk);
    wrap.appendChild(txt);
    box.appendChild(wrap);
  });
}

async function toggleRolePerm(role_id, perm_id, enabled) {
  const form = new FormData();
  form.append('role_id', role_id);
  form.append('perm_id', perm_id);
  form.append('enabled', enabled ? 'true' : 'false');
  await api('/api/v1/security/role-perms/toggle', { method: 'POST', body: form });
  if (enabled) {
    if (!currentRolePermIds.includes(perm_id)) currentRolePermIds.push(perm_id);
  } else {
    currentRolePermIds = currentRolePermIds.filter(x => x !== perm_id);
  }
}

// ---------- employees & user roles ----------
async function fetchEmployees() {
  const resp = await api('/api/v1/security/employees');
  const data = asArray(resp);

  const sel = document.getElementById('empSelect');
  sel.innerHTML = '<option value="">— เลือกพนักงาน —</option>';
  data.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e.id;
    opt.textContent = e.name || `Employee #${e.id}`;
    sel.appendChild(opt);
  });
}

async function loadUserRoles(userId) {
  if (!userId) return;
  const data = await api(`/api/v1/security/user-roles/${userId}`);
  const roleIds = asArray(data.role_ids ?? data);

  // เช็คบ็อกซ์รายการ role สำหรับ user
  const box = document.getElementById('empRoleList');
  box.innerHTML = '';
  roles.forEach(r => {
    const wrap = document.createElement('label');
    wrap.className = "flex items-center gap-3 border rounded px-3 py-2";

    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = roleIds.includes(r.id);
    chk.addEventListener('change', () => toggleUserRole(userId, r.id, chk.checked));

    const txt = document.createElement('div');
    txt.innerHTML = `<div class="font-medium">${r.name}</div>`;

    wrap.appendChild(chk);
    wrap.appendChild(txt);
    box.appendChild(wrap);
  });
}

async function toggleUserRole(user_id, role_id, enabled) {
  const form = new FormData();
  form.append('user_id', user_id);
  form.append('role_id', role_id);
  form.append('enabled', enabled ? 'true' : 'false');
  await api('/api/v1/security/user-roles/toggle', { method: 'POST', body: form });
}

// ---------- events ----------
document.getElementById('roleSelect').addEventListener('change', async (e) => {
  currentRoleId = parseInt(e.target.value, 10);
  await loadRolePerms(currentRoleId);
  renderPerms();
});

document.getElementById('empSelect').addEventListener('change', async (e) => {
  currentUserId = parseInt(e.target.value || '0', 10) || null;
  await loadUserRoles(currentUserId);
});

// ---------- init ----------
(async function init(){
  await loadRoles();
  await loadPerms();
  if (currentRoleId) await loadRolePerms(currentRoleId);
  renderPerms();
  await fetchEmployees();
})();
</script>
{% endblock %}
