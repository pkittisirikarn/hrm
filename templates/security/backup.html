{% extends "base.html" %}
{% block title %}สำรอง/กู้คืนฐานข้อมูล{% endblock %}
{% block content %}
<div class="bg-white rounded-lg shadow p-6 space-y-4">
  <h2 class="text-2xl font-bold">สำรอง/กู้คืนฐานข้อมูล</h2>

  <div class="flex gap-3">
    <button id="btn-backup" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">สร้าง Backup</button>
    <form id="f-restore-upload" class="flex items-center gap-2" enctype="multipart/form-data">
      <input type="file" id="restore-file" name="file" class="border rounded-lg px-3 py-2" accept=".sqlite,.db" />
      <button class="px-4 py-2 rounded-lg bg-blue-600 text-white">Restore (อัปโหลด)</button>
    </form>
  </div>

  <div class="mt-4">
    <div class="font-semibold mb-2">ไฟล์ Backup ที่มี</div>
    <table class="min-w-full text-sm">
      <thead><tr><th class="text-left py-2">ไฟล์</th><th class="text-left py-2">ขนาด</th><th></th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script>
(async function(){
  async function load(){
    const res = await fetch('/api/v1/security/db/backups');
    if(!res.ok){ alert('ต้องเป็น admin เท่านั้น'); return; }
    const rows = await res.json();
    const tb = document.getElementById('rows');
    tb.innerHTML = rows.map(r=>`
      <tr class="border-b">
        <td class="py-2">${r.name}</td>
        <td class="py-2">${r.size} bytes</td>
        <td class="py-2">
          <a class="text-blue-600 hover:underline" href="/api/v1/security/db/download?name=${encodeURIComponent(r.name)}">ดาวน์โหลด</a>
          <button data-restore="${r.name}" class="ml-3 text-red-600 hover:underline">Restore</button>
        </td>
      </tr>
    `).join('');
    tb.querySelectorAll('button[data-restore]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const name = b.getAttribute('data-restore');
        const fd = new FormData();
        fd.append('name', name);
        const r = await fetch('/api/v1/security/db/restore', {method:'POST', body:fd});
        alert(r.ok ? 'Restore สำเร็จ โปรดรีสตาร์ทแอป' : 'Restore ไม่สำเร็จ');
      });
    });
  }

  document.getElementById('btn-backup').addEventListener('click', async ()=>{
    const r = await fetch('/api/v1/security/db/backup', {method:'POST'});
    alert(r.ok ? 'สร้าง Backup แล้ว' : 'ไม่สำเร็จ');
    load();
  });

  document.getElementById('f-restore-upload').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const r = await fetch('/api/v1/security/db/restore', {method:'POST', body: fd});
    alert(r.ok ? 'Restore จากไฟล์สำเร็จ โปรดรีสตาร์ทแอป' : 'Restore ไม่สำเร็จ');
  });

  load();
})();
</script>
{% endblock %}
