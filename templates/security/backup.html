{% extends "base.html" %}
{% block title %}สำรอง/กู้คืนฐานข้อมูล{% endblock %}
{% block content %}
<div class="bg-white rounded shadow p-4">
  <h1 class="text-xl font-semibold mb-4">สำรอง/กู้คืนฐานข้อมูล</h1>

  <div class="flex items-center gap-2 mb-4">
    <button id="btnBackup" class="px-3 py-2 bg-blue-600 text-white rounded">สร้างไฟล์สำรอง</button>
    <input id="fileUp" type="file" class="ml-2">
    <button id="btnRestoreUpload" class="px-3 py-2 bg-amber-600 text-white rounded">กู้คืนจากไฟล์</button>
  </div>

  <h2 class="font-semibold mb-2">ไฟล์สำรอง</h2>
  <ul id="list" class="list-disc pl-6 text-sm"></ul>
</div>
{% endblock %}

{% block scripts %}
<script>
async function api(url, opts={}){ const r=await fetch(url,opts); if(!r.ok) throw new Error(await r.text()); return r.json(); }

async function refresh(){
  const rows = await api('/api/v1/security/db/backups');
  const ul = document.getElementById('list'); ul.innerHTML='';
  rows.forEach(x=>{
    const li = document.createElement('li');
    li.innerHTML = `
      ${x.name} (${(x.size/1024).toFixed(1)} KB)
      <a class="text-blue-600 underline ml-2" href="/api/v1/security/db/download?name=${encodeURIComponent(x.name)}">ดาวน์โหลด</a>
      <button data-name="${x.name}" class="restore-name text-amber-700 underline ml-2">กู้คืน</button>
    `;
    ul.appendChild(li);
  });
  document.querySelectorAll('.restore-name').forEach(btn=>{
    btn.onclick = async () => {
      const fd = new FormData(); fd.append('name', btn.dataset.name);
      await api('/api/v1/security/db/restore', { method:'POST', body: fd });
      alert('กู้คืนแล้ว กรุณา restart แอปเพื่อให้ connection รีโหลดใหม่');
    };
  });
}

document.getElementById('btnBackup').onclick = async() => { await api('/api/v1/security/db/backup', {method:'POST'}); await refresh(); };
document.getElementById('btnRestoreUpload').onclick = async() => {
  const f = document.getElementById('fileUp').files[0];
  if(!f){ alert('เลือกไฟล์ก่อน'); return; }
  const fd = new FormData(); fd.append('file', f);
  await api('/api/v1/security/db/restore', { method:'POST', body: fd });
  alert('กู้คืนแล้ว กรุณา restart แอปเพื่อให้ connection รีโหลดใหม่');
};
refresh();
</script>
{% endblock %}
