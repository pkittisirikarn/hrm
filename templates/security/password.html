{% extends "base.html" %}
{% block title %}เปลี่ยนรหัสผ่าน{% endblock %}
{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- ผู้ใช้เปลี่ยนรหัสของตัวเอง -->
  <div class="bg-white rounded-lg shadow p-6 space-y-4 max-w-lg">
    <h2 class="text-2xl font-bold">เปลี่ยนรหัสผ่านของฉัน</h2>
    <form id="f-change" class="space-y-3">
      <label class="block">
        <div class="text-sm text-gray-600">รหัสผ่านเดิม</div>
        <input type="password" name="current_password" class="w-full border rounded-lg px-3 py-2" required />
      </label>
      <label class="block">
        <div class="text-sm text-gray-600">รหัสผ่านใหม่ (อย่างน้อย 8 ตัวอักษร)</div>
        <input type="password" name="new_password" class="w-full border rounded-lg px-3 py-2" required minlength="8" />
      </label>
      <label class="block">
        <div class="text-sm text-gray-600">ยืนยันรหัสผ่านใหม่</div>
        <input type="password" name="confirm_password" class="w-full border rounded-lg px-3 py-2" required minlength="8" />
      </label>
      <button class="px-4 py-2 rounded-lg bg-blue-600 text-white">บันทึก</button>
    </form>
  </div>

  <!-- แอดมินตั้งรหัสให้พนักงานคนอื่น -->
  <div class="bg-white rounded-lg shadow p-6 space-y-4 max-w-lg">
    <h2 class="text-2xl font-bold">ตั้งรหัสผ่านให้ผู้ใช้งาน</h2>
    <form id="f-reset" class="space-y-3">
      <label class="block">
        <div class="text-sm text-gray-600">พนักงาน</div>
        <select name="user_id" id="emp" class="w-full border rounded-lg px-3 py-2" required>
          <option value="">— เลือกพนักงาน —</option>
        </select>
      </label>
      <label class="block">
        <div class="text-sm text-gray-600">รหัสผ่านใหม่ (อย่างน้อย 8 ตัวอักษร)</div>
        <input type="password" name="new_password" class="w-full border rounded-lg px-3 py-2" required minlength="8" />
      </label>
      <label class="block">
        <div class="text-sm text-gray-600">ยืนยันรหัสผ่านใหม่</div>
        <input type="password" name="confirm_password" class="w-full border rounded-lg px-3 py-2" required minlength="8" />
      </label>
      <button class="px-4 py-2 rounded-lg bg-blue-600 text-white">ตั้งรหัส</button>
      <p class="text-xs text-gray-500">* ไม่ต้องกรอกรหัสเดิม เพราะเป็นการรีเซ็ตโดยผู้ดูแลระบบ</p>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function api(url, opts = {}) {
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error(await res.text() || res.statusText);
  return res.json().catch(() => ({}));
}

// โหลดรายชื่อพนักงานไว้ใส่ dropdown (ใช้อะไรก็ได้ที่คืนรายการพนักงาน)
// มี endpoint รายชื่อพนักงานอยู่แล้ว: GET /api/v1/data-management/employees/?limit=1000
async function loadEmployees() {
  try {
    const data = await api('/api/v1/data-management/employees/?limit=1000');
    const sel = document.getElementById('emp');
    (data || []).forEach(e => {
      const opt = document.createElement('option');
      // ปรับชื่อที่แสดงตามที่ต้องการ
      opt.value = e.id;
      opt.textContent = `${e.first_name || ''} ${e.last_name || ''} — ${e.email || ''}`.trim();
      sel.appendChild(opt);
    });
  } catch (err) {
    console.error('โหลดรายชื่อพนักงานล้มเหลว', err);
  }
}
loadEmployees();

document.getElementById('f-change')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  if (fd.get('new_password') !== fd.get('confirm_password')) {
    alert('รหัสผ่านใหม่ไม่ตรงกัน'); return;
  }
  const r = await fetch('/api/v1/security/password/change', { method: 'POST', body: fd });
  if (r.ok) { alert('เปลี่ยนรหัสผ่านสำเร็จ'); e.target.reset(); }
  else { alert('ไม่สำเร็จ: ' + (await r.text())); }
});

document.getElementById('f-reset')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  if (fd.get('new_password') !== fd.get('confirm_password')) {
    alert('รหัสผ่านใหม่ไม่ตรงกัน'); return;
  }
  // API รีเซ็ตสำหรับแอดมิน
  const body = new FormData();
  body.append('user_id', fd.get('user_id'));
  body.append('new_password', fd.get('new_password'));
  const r = await fetch('/api/v1/security/password/reset', { method: 'POST', body });
  if (r.ok) { alert('ตั้งรหัสผ่านสำเร็จ'); e.target.reset(); }
  else { alert('ไม่สำเร็จ: ' + (await r.text())); }
});
</script>
{% endblock %}
