{% extends "base.html" %}
{% block title %}ผู้สมัครงาน{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-6 space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-bold">ผู้สมัครงาน</h2>
    <a href="/recruitment/candidate/new" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">+ เพิ่มผู้สมัคร</a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
    <input id="f-q" class="border rounded-lg px-3 py-2" placeholder="ค้นหา: ชื่อ/อีเมล/ตำแหน่ง">
    <select id="f-status" class="border rounded-lg px-3 py-2">
      <option value="">— สถานะทั้งหมด —</option>
      {% for enum, label in status_th.items() %}
      <option value="{{ enum.value }}">{{ label }}</option>
      {% endfor %}
    </select>
    <input id="f-source" class="border rounded-lg px-3 py-2" placeholder="แหล่งที่มา (referral/job board)">
    <input id="f-dept" class="border rounded-lg px-3 py-2" placeholder="แผนก">
    <button id="btn-search" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">ค้นหา</button>
  </div>

  <div class="overflow-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2 pr-2">ชื่อ</th>
          <th class="py-2 pr-2">ตำแหน่ง</th>
          <th class="py-2 pr-2">แผนก</th>
          <th class="py-2 pr-2">สถานะ</th>
          <th class="py-2 pr-2">อัปเดต</th>
          <th class="py-2 pr-2">การทำงาน</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- Modal ดูไฟล์ -->
<div id="file-modal" class="fixed inset-0 hidden bg-black/30 z-50">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl mx-auto mt-24 p-6">
    <div class="flex items-center justify-between mb-4">
      <div class="text-lg font-semibold">ไฟล์แนบ</div>
      <button id="file-close" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200">ปิด</button>
    </div>
    <div id="file-list" class="space-y-2 text-sm"></div>
  </div>
</div>

<!-- map สถานะจาก Jinja -> JS -->
<script id="status_th_json" type="application/json">{{ status_th|tojson }}</script>

<script>
  // @ts-nocheck
  console.log('[Recruit] inline list script loaded');

  window.STATUS_THAI = JSON.parse(document.getElementById('status_th_json').textContent || '{}');

  const rowsEl = document.getElementById('rows');
  const f = {
    q: document.getElementById('f-q'),
    status: document.getElementById('f-status'),
    source: document.getElementById('f-source'),
    dept: document.getElementById('f-dept'),
  };

  // modal helpers
  const modal = document.getElementById('file-modal');
  const fileList = document.getElementById('file-list');
  document.getElementById('file-close').addEventListener('click', ()=> modal.classList.add('hidden'));

  async function openFiles(candidateId) {
    fileList.innerHTML = '<div class="text-gray-500">กำลังโหลด…</div>';
    modal.classList.remove('hidden');
    const r = await fetch(`/api/v1/recruitment/candidates/${candidateId}/files`);
    if (!r.ok) { fileList.innerHTML = '<div class="text-red-600">โหลดไฟล์ไม่สำเร็จ</div>'; return; }
    const files = await r.json();
    if (!files.length) { fileList.innerHTML = '<div class="text-gray-500">ไม่มีไฟล์แนบ</div>'; return; }
    fileList.innerHTML = '';
    files.forEach(f => {
      const a = document.createElement('a');
      a.href = f.file_url; a.target = '_blank'; a.rel = 'noopener';
      a.className = 'block px-3 py-2 rounded border hover:bg-gray-50';
      a.textContent = `${f.original_name || 'ไฟล์'} (${(f.size || 0)} bytes)`;
      fileList.appendChild(a);
    });
  }

  async function load() {
    const url = new URL('/api/v1/recruitment/candidates/', window.location.origin);
    if (f.q.value) url.searchParams.set('q', f.q.value);
    if (f.status.value) url.searchParams.set('status', f.status.value);
    if (f.source.value) url.searchParams.set('source', f.source.value);
    if (f.dept.value) url.searchParams.set('dept', f.dept.value);

    console.log('[Recruit] fetching', url.toString());
    const r = await fetch(url.toString());
    console.log('[Recruit] response', r.status);

    if (!r.ok) {
      rowsEl.innerHTML = '<tr><td class="py-2 text-red-600">โหลดข้อมูลไม่สำเร็จ</td></tr>';
      return;
    }

    const data = await r.json();
    rowsEl.innerHTML = '';

    if (!data.length) {
      rowsEl.innerHTML = '<tr><td class="py-2 text-gray-500">ยังไม่มีข้อมูล</td></tr>';
      return;
    }

    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-gray-50';

      const statusTH = window.STATUS_THAI?.[item.status] || item.status;

      tr.innerHTML = `
            <td class="py-2 pr-2">
        <div class="flex items-center gap-3">
        ${
            item.photo_url
            ? `<img src="${item.photo_url}" class="h-9 w-9 rounded-full object-cover" />`
            : `<div class="h-9 w-9 rounded-full bg-gray-200 flex items-center justify-center text-[10px] text-gray-500">N/A</div>`
        }
        <div>
            <div class="font-medium">${item.full_name}</div>
            <div class="text-xs text-gray-500">${item.email || ''} ${item.phone ? '• ' + item.phone : ''}</div>
        </div>
        </div>
    </td>
    <td class="py-2 pr-2">${item.position_applied || ''}</td>
    <td class="py-2 pr-2">${item.department || ''}</td>
    <td class="py-2 pr-2">${statusTH}</td>
    <td class="py-2 pr-2 text-xs text-gray-500">${new Date(item.stage_updated_at).toLocaleString()}</td>
    <td class="py-2 pr-2 whitespace-nowrap flex gap-3">
        <button class="text-indigo-600 hover:underline" data-files="${item.id}">ไฟล์</button>
        <a class="text-blue-600 hover:underline" href="/recruitment/candidate/edit?id=${item.id}">แก้ไข</a>
        <button class="text-red-600 hover:underline" data-id="${item.id}">ลบ</button>
    </td>`;

      // ✅ bind ปุ่มภายในลูป
      tr.querySelector('[data-files]')?.addEventListener('click', () => openFiles(item.id));
      tr.querySelector('button[data-id]')?.addEventListener('click', async (ev) => {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('ลบผู้สมัครนี้?')) return;
        const rr = await fetch(`/api/v1/recruitment/candidates/${id}`, { method: 'DELETE' });
        if (rr.ok) load(); else alert('ลบไม่สำเร็จ');
      });

      rowsEl.appendChild(tr);
    });
  }

  document.getElementById('btn-search').addEventListener('click', load);
  ['q','status','source','dept'].forEach(k => f[k].addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ load(); }}));

  // โหลดรอบแรก
  load();
</script>
{% endblock %}
