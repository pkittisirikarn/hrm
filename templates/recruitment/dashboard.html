{% extends "base.html" %}
{% block title %}Recruitment Dashboard{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-6 space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-bold">Recruitment Dashboard</h2>
    <a href="/recruitment/candidates" class="text-blue-600 hover:underline">ไปหน้า "จัดการผู้สมัคร" →</a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="p-4 rounded-xl border">
      <div class="text-sm text-gray-500">ผู้สมัครทั้งหมด</div>
      <div id="stat-total" class="text-3xl font-semibold">0</div>
    </div>
    <div class="p-4 rounded-xl border"><canvas id="chart-status" height="180"></canvas></div>
    <!-- เปลี่ยนเป็นกราฟตำแหน่งที่สมัคร -->
    <div class="p-4 rounded-xl border">
      <div class="text-sm text-gray-500 mb-2">ตำแหน่งที่สมัคร</div>
      <canvas id="chart-position" height="180"></canvas>
    </div>
  </div>

  <div class="p-4 rounded-xl border">
    <div class="mb-2 font-medium">ผู้สมัครล่าสุด 30 วัน</div>
    <canvas id="chart-30d" height="100"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  console.log('[Recruit] dashboard js loaded');
  (async function() {
    const res = await fetch('/api/v1/recruitment/stats/overview');
    console.log('[Recruit] stats GET', res.status);
    if (!res.ok) return;
    const data = await res.json();
    console.log('[Recruit] stats payload', data);

    document.getElementById('stat-total').textContent = data.total ?? 0;

    const statusLabelsMap = {
      background_check: 'ตรวจประวัติ',
      waiting_schedule: 'รอนัดหมาย',
      scheduled: 'นัดหมายแล้ว',
      passed: 'ผ่านสัมภาษณ์',
      failed: 'ไม่ผ่าน',
      pending_result: 'รอแจ้งผล'
    };

    // สถานะ (โดนัท)
    const sKeys = Object.keys(data.by_status || {});
    const sVals = sKeys.map(k => data.by_status[k] || 0);
    new Chart(document.getElementById('chart-status'), {
      type: 'doughnut',
      data: { labels: sKeys.map(k => statusLabelsMap[k] || k), datasets: [{ data: sVals }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });

    // ✅ ตำแหน่งที่สมัคร (พาย)
    const posKeys = Object.keys(data.by_position || {});
    const posVals = posKeys.map(k => data.by_position[k] || 0);
    new Chart(document.getElementById('chart-position'), {
      type: 'pie',
      data: { labels: posKeys, datasets: [{ data: posVals }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });

    // 30 วันล่าสุด (ไลน์)
    const days = data.last_30d || [];
    new Chart(document.getElementById('chart-30d'), {
      type: 'line',
      data: {
        labels: days.map(d => d.date),
        datasets: [{ label: 'ผู้สมัคร/วัน', data: days.map(d => d.count), tension: 0.2 }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
  })();
</script>
{% endblock %}
